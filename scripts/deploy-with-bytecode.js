/**
 * Deploy VirtualAgent Contract using pre-compiled bytecode
 * 
 * INSTRU√á√ïES:
 * 1. Compile o contrato no Remix IDE
 * 2. Na aba "Solidity Compiler", clique em "Compilation Details"
 * 3. Copie o "bytecode" (object) - √© uma string longa come√ßando com 0x
 * 4. Cole abaixo onde diz "COLE_O_BYTECODE_AQUI"
 * 5. Execute: node scripts/deploy-with-bytecode.js
 */

const { ethers } = require('ethers')

// Configuration
const PRIVATE_KEY = '7037a2d5e0fab06911c4fc98f09ef19d5558194440d7438bd099ae78e234228c'
const RPC_URL = 'https://rpc.testnet.arc.network'

// COLE O BYTECODE AQUI (do Remix IDE - Compilation Details)
const BYTECODE = '0x608060405234801561000f575f80fd5b506119938061001d5f395ff3fe6080604052600436106100d9575f3560e01c806373e71a1e1161007c578063aaccf1ec11610057578063aaccf1ec14610252578063b03053b614610267578063de74e57b14610286578063e5020d311461030e575f80fd5b806373e71a1e146101f557806391cab63e1461022b5780639eeb151a1461023f575f80fd5b8063513856c8116100b7578063513856c81461016b578063689025f91461018a5780636bcfe5921461019f578063724694f3146101be575f80fd5b80632de5aaf7146100dd57806330efc4981461011c5780634406c9e61461013f575b5f80fd5b3480156100e8575f80fd5b506100fc6100f7366004611351565b61032d565b6040516101139b9a999897969594939291906113ab565b60405180910390f35b348015610127575f80fd5b5061013160015481565b604051908152602001610113565b34801561014a575f80fd5b5061015e610159366004611351565b6105eb565b6040516101139190611445565b348015610176575f80fd5b506100fc610185366004611351565b6106cc565b61019d6101983660046114a5565b610944565b005b3480156101aa575f80fd5b506101316101b93660046114c5565b610b84565b3480156101c9575f80fd5b506101dd6101d83660046114a5565b610bad565b6040516001600160a01b039091168152602001610113565b348015610200575f80fd5b5061013161020f3660046114c5565b600260209081525f928352604080842090915290825290205481565b348015610236575f80fd5b50600154610131565b61019d61024d3660046114a5565b610be1565b34801561025d575f80fd5b5061013160055481565b348015610272575f80fd5b506101316102813660046114fe565b610f5f565b348015610291575f80fd5b506102dc6102a0366004611351565b600460208190525f91825260409091208054600182015460028301546003840154939094015491936001600160a01b0390911692909160ff1685565b604080519586526001600160a01b0390941660208601529284019190915260608301521515608082015260a001610113565b348015610319575f80fd5b50610131610328366004611673565b6110f9565b5f806060806060805f805f805f805f808e81526020019081526020015f209050805f0154816001015f9054906101000a90046001600160a01b03168260020183600301846004018560050186600701548760080154886009015489600a01548a600b015f9054906101000a900460ff168880546103a99061174e565b80601f01602080910402602001604051908101604052809291908181526020018280546103d59061174e565b80156104205780601f106103f757610100808354040283529160200191610420565b820191905f5260205f20905b81548152906001019060200180831161040357829003601f168201915b505050505098508780546104339061174e565b80601f016020809104026020016040519081016040528092919081815260200182805461045f9061174e565b80156104aa5780601f10610481576101008083540402835291602001916104aa565b820191905f5260205f20905b81548152906001019060200180831161048d57829003601f168201915b505050505097508680546104bd9061174e565b80601f01602080910402602001604051908101604052809291908181526020018280546104e99061174e565b80156105345780601f1061050b57610100808354040283529160200191610534565b820191905f5260205f20905b81548152906001019060200180831161051757829003601f168201915b505050505096508580546105479061174e565b80601f01602080910402602001604051908101604052809291908181526020018280546105739061174e565b80156105be5780601f10610595576101008083540402835291602001916105be565b820191905f5260205f20905b8154815290600101906020018083116105a157829003601f168201915b505050505095509b509b509b509b509b509b509b509b509b509b509b505091939597999b90929496989a50565b5f81815260208181526040808320600601805482518185028101850190935280835260609492939192909184015b828210156106c1578382905f5260205f200180546106369061174e565b80601f01602080910402602001604051908101604052809291908181526020018280546106629061174e565b80156106ad5780601f10610684576101008083540402835291602001916106ad565b820191905f5260205f20905b81548152906001019060200180831161069057829003601f168201915b505050505081526020019060010190610619565b505050509050919050565b5f6020819052908152604090208054600182015460028301805492936001600160a01b03909216926106fd9061174e565b80601f01602080910402602001604051908101604052809291908181526020018280546107299061174e565b80156107745780601f1061074b57610100808354040283529160200191610774565b820191905f5260205f20905b81548152906001019060200180831161075757829003601f168201915b5050505050908060030180546107899061174e565b80601f01602080910402602001604051908101604052809291908181526020018280546107b59061174e565b80156108005780601f106107d757610100808354040283529160200191610800565b820191905f5260205f20905b8154815290600101906020018083116107e357829003601f168201915b5050505050908060040180546108159061174e565b80601f01602080910402602001604051908101604052809291908181526020018280546108419061174e565b801561088c5780601f106108635761010080835404028352916020019161088c565b820191905f5260205f20905b81548152906001019060200180831161086f57829003601f168201915b5050505050908060050180546108a19061174e565b80601f01602080910402602001604051908101604052809291908181526020018280546108cd9061174e565b80156109185780601f106108ef57610100808354040283529160200191610918565b820191905f5260205f20905b8154815290600101906020018083116108fb57829003601f168201915b505050600784015460088501546009860154600a870154600b9097015495969295919450925060ff168b565b5f828152602081905260409020600b81015460ff1661099d5760405162461bcd60e51b815260206004820152601060248201526f4167656e74206e6f742061637469766560801b60448201526064015b60405180910390fd5b5f82116109bc5760405162461bcd60e51b815260040161099490611786565b80600801548282600901546109d191906117c6565b1115610a165760405162461bcd60e51b81526020600482015260146024820152734578636565647320746f74616c20737570706c7960601b6044820152606401610994565b5f828260070154610a2791906117d9565b905080341015610a705760405162461bcd60e51b8152602060048201526014602482015273125b9cdd59999a58da595b9d081c185e5b595b9d60621b6044820152606401610994565b5f8481526002602090815260408083203384529091528120549003610abd575f8481526003602090815260408220805460018101825590835291200180546001600160a01b031916331790555b5f84815260026020908152604080832033845290915281208054859290610ae59084906117c6565b9250508190555082826009015f828254610aff91906117c6565b909155505034811015610b4157336108fc610b1a83346117f0565b6040518115909202915f818181858888f19350505050158015610b3f573d5f803e3d5ffd5b505b6040805184815260208101839052339186917f8dcda1697246026d228fb92acd778f9333313c10796dbaa64a0d919c526ef7e5910160405180910390a350505050565b5f8281526002602090815260408083206001600160a01b03851684529091529020545b92915050565b6003602052815f5260405f208181548110610bc6575f80fd5b5f918252602090912001546001600160a01b03169150829050565b5f8281526004602081905260409091209081015460ff16610c395760405162461bcd60e51b81526020600482015260126024820152714c697374696e67206e6f742061637469766560701b6044820152606401610994565b5f8211610c585760405162461bcd60e51b815260040161099490611786565b8060030154821115610ca55760405162461bcd60e51b8152602060048201526016602482015275416d6f756e742065786365656473206c697374696e6760501b6044820152606401610994565b5f828260020154610cb691906117d9565b905080341015610cff5760405162461bcd60e51b8152602060048201526014602482015273125b9cdd59999a58da595b9d081c185e5b595b9d60621b6044820152606401610994565b81545f90815260026020908152604080832060018601546001600160a01b03168452909152902054831115610d765760405162461bcd60e51b815260206004820152601b60248201527f53656c6c657220696e73756666696369656e742062616c616e636500000000006044820152606401610994565b81545f90815260026020908152604080832060018601546001600160a01b0316845290915281208054859290610dad9084906117f0565b909155505081545f9081526002602090815260408083203384529091528120549003610e035781545f9081526003602090815260408220805460018101825590835291200180546001600160a01b031916331790555b81545f90815260026020908152604080832033845290915281208054859290610e2d9084906117c6565b9250508190555082826003015f828254610e4791906117f0565b909155505060038201545f03610e645760048201805460ff191690555b60018201546040516001600160a01b039091169082156108fc029083905f818181858888f19350505050158015610e9d573d5f803e3d5ffd5b5080341115610edb57336108fc610eb483346117f0565b6040518115909202915f818181858888f19350505050158015610ed9573d5f803e3d5ffd5b505b604051838152339085907ff4db9839cb6de8cbeca7b39bc74f8fd501b7790ee5ac387e2b46f9f93fbe11989060200160405180910390a36001820154825460405185815233926001600160a01b031691907f06f354ec7b9d2ca4e029f73ccb9119943a48c3295704dd66ca8beda0c7bae33f9060200160405180910390a450505050565b5f838152600260209081526040808320338452909152812054821115610fbe5760405162461bcd60e51b8152602060048201526014602482015273496e73756666696369656e742062616c616e636560601b6044820152606401610994565b5f83116110015760405162461bcd60e51b815260206004820152601160248201527005072696365206d757374206265203e203607c1b6044820152606401610994565b5f82116110205760405162461bcd60e51b815260040161099490611786565b600580545f918261103083611803565b909155506040805160a0810182528781523360208083018281528385018a8152606085018a81526001608087018181525f8a81526004808852908a902098518955945191880180546001600160a01b0319166001600160a01b039093169290921790915591516002870155516003860155519301805460ff1916931515939093179092558251888152918201879052929350879184917f492d2294f1b8a982001da6ecb3de3a374ad9c29c9c8d5ad43da90cc50b585136910160405180910390a4949350505050565b5f8088511161113a5760405162461bcd60e51b815260206004820152600d60248201526c13985b59481c995c5d5a5c9959609a1b6044820152606401610994565b5f831161117d5760405162461bcd60e51b815260206004820152601160248201527005072696365206d757374206265203e203607c1b6044820152606401610994565b5f82116111c15760405162461bcd60e51b81526020600482015260126024820152710537570706c79206d757374206265203e20360741b6044820152606401610994565b600180545f91826111d183611803565b909155505f8181526020819052604090208181556001810180546001600160a01b031916331790559091506002810161120a8b82611869565b50600381016112198a82611869565b50600481016112288982611869565b50600581016112378882611869565b5060078101859055600881018490555f6009820181905542600a830155600b8201805460ff191660011790555b86518110156112be578160060187828151811061128357611283611925565b60209081029190910181015182546001810184555f9384529190922001906112ab9082611869565b50806112b681611803565b915050611264565b505f828152600260209081526040808320338085529083528184208890558584526003835281842080546001810182559085529290932090910180546001600160a01b031916831790555183907f8558fde4efaf898722d0cb1dc7000e4dfbe6660d28a5173ba22ee2c6182149959061133c908e908a908a90611939565b60405180910390a35098975050505050505050565b5f60208284031215611361575f80fd5b5035919050565b5f81518084525f5b8181101561138c57602081850181015186830182015201611370565b505f602082860101526020601f19601f83011685010191505092915050565b8b81526001600160a01b038b166020820152610160604082018190525f906113d58382018d611368565b905082810360608401526113e9818c611368565b905082810360808401526113fd818b611368565b905082810360a0840152611411818a611368565b60c0840198909852505060e08101949094526101008401929092526101208301521515610140909101529695505050505050565b5f602080830181845280855180835260408601915060408160051b87010192508387015f5b8281101561149857603f19888603018452611486858351611368565b9450928501929085019060010161146a565b5092979650505050505050565b5f80604083850312156114b6575f80fd5b50508035926020909101359150565b5f80604083850312156114d6575f80fd5b8235915060208301356001600160a01b03811681146114f3575f80fd5b809150509250929050565b5f805f60608486031215611510575f80fd5b505081359360208301359350604090920135919050565b634e487b7160e01b5f52604160045260245ffd5b604051601f8201601f1916810167ffffffffffffffff8111828210171561156457611564611527565b604052919050565b5f82601f83011261157b575f80fd5b813567ffffffffffffffff81111561159557611595611527565b6115a8601f8201601f191660200161153b565b8181528460208386010111156115bc575f80fd5b816020850160208301375f918101602001919091529392505050565b5f82601f8301126115e7575f80fd5b8135602067ffffffffffffffff8083111561160457611604611527565b8260051b61161383820161153b565b938452858101830193838101908886111561162c575f80fd5b84880192505b8583101561166757823584811115611649575f8081fd5b6116578a87838c010161156c565b8352509184019190840190611632565b98975050505050505050565b5f805f805f805f60e0888a031215611689575f80fd5b873567ffffffffffffffff808211156116a0575f80fd5b6116ac8b838c0161156c565b985060208a01359150808211156116c1575f80fd5b6116cd8b838c0161156c565b975060408a01359150808211156116e2575f80fd5b6116ee8b838c0161156c565b965060608a0135915080821115611703575f80fd5b61170f8b838c0161156c565b955060808a0135915080821115611724575f80fd5b506117318a828b016115d8565b93505060a0880135915060c0880135905092959891949750929550565b600181811c9082168061176257607f821691505b60208210810361178057634e487b7160e01b5f52602260045260245ffd5b50919050565b6020808252601290820152710416d6f756e74206d757374206265203e20360741b604082015260600190565b634e487b7160e01b5f52601160045260245ffd5b80820180821115610ba757610ba76117b2565b8082028115828204841417610ba757610ba76117b2565b81810381811115610ba757610ba76117b2565b5f60018201611814576118146117b2565b5060010190565b601f821115611864575f81815260208120601f850160051c810160208610156118415750805b601f850160051c820191505b818110156118605782815560010161184d565b5050505b505050565b815167ffffffffffffffff81111561188357611883611527565b61189781611891845461174e565b8461181b565b602080601f8311600181146118ca575f84156118b35750858301515b5f19600386901b1c1916600185901b178555611860565b5f85815260208120601f198616915b828110156118f8578886015182559484019460019091019084016118d9565b508582101561191557878501515f19600388901b60f8161c191681555b5050505050600190811b01905550565b634e487b7160e01b5f52603260045260245ffd5b606081525f61194b6060830186611368565b6020830194909452506040015291905056fea2646970667358221220727075532666b8148d7263af2d241ee5dd528ded7fdba0d6db65f23f87ddb51064736f6c63430008140033'

// ABI m√≠nimo (apenas constructor)
const ABI = [
  {
    "inputs": [],
    "stateMutability": "nonpayable",
    "type": "constructor"
  }
]

async function deploy() {
  try {
    console.log('üöÄ Deploy do contrato VirtualAgent na Arc Testnet...\n')
    
    if (BYTECODE === 'COLE_O_BYTECODE_AQUI' || !BYTECODE.startsWith('0x')) {
      console.error('‚ùå ERRO: Bytecode n√£o configurado!')
      console.log('\nüìã Como obter o bytecode:')
      console.log('   1. Abra o Remix IDE: https://remix.ethereum.org/')
      console.log('   2. Compile o contrato VirtualAgent.sol')
      console.log('   3. Na aba "Solidity Compiler", clique em "Compilation Details"')
      console.log('   4. Procure por "bytecode" ‚Üí "object"')
      console.log('   5. Copie a string completa (come√ßa com 0x)')
      console.log('   6. Cole no arquivo deploy-with-bytecode.js na vari√°vel BYTECODE\n')
      process.exit(1)
    }
    
    // Create provider
    const provider = new ethers.JsonRpcProvider(RPC_URL)
    
    // Create wallet
    const wallet = new ethers.Wallet(PRIVATE_KEY, provider)
    
    console.log('üë§ Deployer:', wallet.address)
    console.log('üìç Rede: Arc Testnet')
    console.log('üîó RPC:', RPC_URL, '\n')
    
    // Check balance
    const balance = await provider.getBalance(wallet.address)
    const balanceFormatted = ethers.formatEther(balance)
    console.log('üí∞ Saldo:', balanceFormatted, 'USDC')
    
    if (balance === 0n) {
      console.error('\n‚ùå Saldo insuficiente!')
      console.log('üí° Obtenha USDC testnet em: https://easyfaucetarc.xyz/')
      console.log('üìã Endere√ßo:', wallet.address)
      process.exit(1)
    }
    
    console.log('\nüì¶ Criando factory do contrato...')
    const factory = new ethers.ContractFactory(ABI, BYTECODE, wallet)
    
    console.log('üöÄ Fazendo deploy...')
    const contract = await factory.deploy()
    
    console.log('‚è≥ Aguardando confirma√ß√£o da transa√ß√£o...')
    await contract.waitForDeployment()
    
    const contractAddress = await contract.getAddress()
    const txHash = contract.deploymentTransaction()?.hash
    
    console.log('\n‚úÖ Contrato deployado com sucesso!')
    console.log('üìç Endere√ßo do contrato:', contractAddress)
    console.log('üîó Transaction hash:', txHash)
    console.log('üåê Ver no ArcScan:', `https://testnet.arcscan.app/address/${contractAddress}`)
    console.log('üåê Ver transa√ß√£o:', `https://testnet.arcscan.app/tx/${txHash}`)
    
    // Update .env.local
    const envLocalPath = path.join(__dirname, '../.env.local')
    if (fs.existsSync(envLocalPath)) {
      let envContent = fs.readFileSync(envLocalPath, 'utf8')
      envContent = envContent.replace(
        /NEXT_PUBLIC_VIRTUAL_AGENT_ADDRESS=.*/,
        `NEXT_PUBLIC_VIRTUAL_AGENT_ADDRESS=${contractAddress}`
      )
      if (!envContent.includes('NEXT_PUBLIC_VIRTUAL_AGENT_ADDRESS')) {
        envContent += `\nNEXT_PUBLIC_VIRTUAL_AGENT_ADDRESS=${contractAddress}`
      }
      fs.writeFileSync(envLocalPath, envContent)
      console.log('\n‚úÖ .env.local atualizado automaticamente!')
    } else {
      console.log('\nüìù Adicione ao .env.local:')
      console.log(`NEXT_PUBLIC_VIRTUAL_AGENT_ADDRESS=${contractAddress}`)
    }
    
    console.log('\nüéâ Deploy conclu√≠do!')
    
  } catch (error) {
    console.error('\n‚ùå Erro no deploy:', error.message)
    if (error.transaction) {
      console.error('Transaction hash:', error.transaction.hash)
    }
    if (error.reason) {
      console.error('Raz√£o:', error.reason)
    }
    process.exit(1)
  }
}

const fs = require('fs')
const path = require('path')

deploy()

